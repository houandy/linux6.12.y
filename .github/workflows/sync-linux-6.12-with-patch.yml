# Linux 6.12 源码克隆+打补丁+同步仓库工作流
name: Sync Linux 6.12 Source with Patch

# 触发条件：支持手动触发/定时触发（可选）
on:
  # 手动触发（核心）
  workflow_dispatch:
  # 定时触发：每周日凌晨2点同步一次最新6.12源码（可选）
  # schedule:
  #   - cron: '0 2 * * 0'

# 工作流权限：需要写入仓库的权限（关键）
permissions:
  contents: write  # 允许推送代码到仓库
  actions: read

jobs:
  sync-linux-source:
    runs-on: ubuntu-22.04
    name: Clone Linux 6.12 + Apply Patch + Sync to Repo

    steps:
      # 步骤1: 检出你的目标仓库（用于存放打完补丁的源码）
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整仓库历史（方便推送）
          token: ${{ secrets.GITHUB_TOKEN }}  # 默认Token，也可使用PAT

      # 步骤2: 安装基础依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git patch wget curl

      # 步骤3: 克隆 Linux 6.12 最新稳定版源码
      - name: Clone Linux 6.12 Latest Source
        run: |
          # 定义版本和目录
          LINUX_TAG="v6.12"
          LINUX_DIR="linux-6.12-patched"
          
          # 克隆6.12最新源码（深度1，加快速度）
          git clone --depth 1 --branch $LINUX_TAG https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git $LINUX_DIR
          cd $LINUX_DIR
          
          # 补全git信息（方便后续提交）
          git fetch --unshallow || true
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 验证版本
          echo "Cloned Linux version: $(make kernelversion 2>/dev/null || echo $LINUX_TAG)"

      # 步骤4: 应用自定义补丁
      - name: Apply Custom Patches
        run: |
          LINUX_DIR="linux-6.12-patched"
          cd $LINUX_DIR

          # 检查补丁目录是否存在
          if [ -d "../patches" ] && [ $(ls -1 ../patches/*.patch 2>/dev/null | wc -l) -gt 0 ]; then
            echo "Applying patches from patches/ directory..."
            # 按顺序应用所有.patch文件
            for patch in ../patches/*.patch; do
              if [ -f "$patch" ]; then
                echo "Applying patch: $patch"
                # 使用git apply（兼容内核补丁），失败则终止
                git apply "$patch" || {
                  echo "ERROR: Failed to apply patch $patch"
                  exit 1
                }
              fi
            done
            echo "All patches applied successfully!"
          else
            echo "No patches found in patches/ directory, skipping patching step."
          fi

      # 步骤5: 清理无关文件（减小仓库体积）
      - name: Clean Unnecessary Files
        run: |
          LINUX_DIR="linux-6.12-patched"
          cd $LINUX_DIR
          # 删除git目录（避免嵌套仓库）
          rm -rf .git
          # 删除编译产物/临时文件（如果有）
          rm -rf .config .config.old include/config
          # 删除无用文档（可选，进一步减小体积）
          # rm -rf Documentation/ samples/ tools/

      # 步骤6: 将打完补丁的源码同步回仓库
      - name: Push Patched Source to Repository
        run: |
          LINUX_DIR="linux-6.12-patched"
          BRANCH="linux-6.12-patched"  # 存放补丁源码的分支

          # 创建/切换到目标分支
          git checkout -b $BRANCH || git checkout $BRANCH
          
          # 删除旧的源码目录（如果存在）
          rm -rf $LINUX_DIR
          
          # 将打完补丁的源码移动到仓库根目录
          mv ../$LINUX_DIR .
          
          # 提交并推送代码
          git add $LINUX_DIR/
          git commit -m "Sync Linux 6.12 source with custom patches ($(date +%Y-%m-%d))" || echo "No changes to commit"
          git push origin $BRANCH --force  # --force 覆盖旧版本（可选，根据需求调整）

      # 可选步骤: 生成补丁应用日志（方便排查问题）
      - name: Upload Patch Log
        uses: actions/upload-artifact@v4
        with:
          name: patch-apply-log
          path: |
            /tmp/patch_apply.log
          retention-days: 7
